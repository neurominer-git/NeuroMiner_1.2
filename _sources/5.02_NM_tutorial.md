(5.02_tutorial)=
# NeuroMiner tutorial

This NeuroMiner tutorial will serve as a basic introduction to the main NeuroMiner functions you need to do in order to run your first machine learning analysis. That is, you will learn about [data entry](input_data), [training](train_supervised_classifiers), [visualization](visualize_classifiers), [interpretation](interprete_models) and [external application](OOCV_analysis). 

Keep in mind that you have to have MATLAB version R2022b in order for NeuroMiner to function properly on each operation system (R2023b or newer for Mac OS with M1 or M2 chip). 

First, you need to add the NeuroMiner directory (which you can download from here: https://github.com/neurominer-git/NeuroMiner_1.2) to the MATLAB search path. 


## Data entry

Neurominer supports the entry of various data types, here we will import matrix data from a text file using simulated brain parcellation data. We have included the example data in the NeuroMiner installation, you will find it in the sub-directory NeuroMiner_1.2/example_data_simulated/

We will start by loading the covars.mat file into Matlab. This needs to be done before starting NeuroMiner. See [here](input_data) for more information. One way to load the data is by executing 

```
load((PATH/TO/NeuroMiner_1.2/example_data_simulated/covars.mat))
```
Now, you should see two variables in the workspace 'covars' and 'covarsNames'. We will need them later. Then, open NeuroMiner by typing: 

```
>> nm
```

NeuroMiner has a text-based interface, you navigate it by typing the numbers offered on the menu, or the letter Q in case you want to go back to the previous menu/exit.

For now, choose option **>> 1 (Load data for model discovery and cross-validation)**. This opens the NM data workspace manager menu. Then, select **>> 2 (Select data input format)**, and then  **>> 4 Matrix data (2D)** (since, in this example, we want to analyze tabular data from a spreadsheet). Once you are back to the NM workspace manager window, select **>> 3 (Define data provenance)** followed by **>> 4 (from text file)**. A pop-up box will subsequently appear where we select the file of interest. In this case it is example_roidata.csv which you can find in the /example_data_simulated/.  

Selecting the file updates the NM workspace manager and you'll see more options to choose from. All the settings that still need to be completed are marked with **?**. We need to specify the column delimiter used, and the column names containing subject identifiers and our outcome label. To do so, follow these steps: 

1. Select **comma** as the delimiter. 
2. The label column is called **group** (a variable which distinguishes between patients and controls) [press enter button]
3. The name of the column in the csv-file containing the case identifiers (ID)is called **ID** (marks individual cases) [press enter button]
4. Describe the data being entered, e.g., **NeuroMiner example data** [press enter button]

Now that all the necessary fields are defined, you can import the matrix by selecting **>>10 (IMPORT matrix)**. 

Now we have a chance to add another data modality here or modify an existing one, delete it, delete all data, add covariates, or finish data import for discovery and cross-validation analysis.

Right now, we’re only interested in adding the covariates we have previously loaded into MATLAB by executing:  **>> 5 (Add covariate(s) to NM workspace)**, type **covars** (i.e., the name of the variable in the Matlab workspace containing the data)[press enter button], then, press **v**, followed by **CovarsNames** (i.e., the name of the variable´ in the Matlab workspace containing the names of the covariates) [press enter button]. 

Then, you will be shown a summary of the data that will be entered in your machine learning analysis. Having had this overview, choose **>> 7 (Finish data import for discovery & cross-validation analysis)**. You will not be able to go back to the data entry after finishing the import module. This will then take us to the MAIN INTERFACE of NeuroMiner, where you can select **>> 4 (Save NeuroMiner structure)**. It is good practice to save your NM structure regularly to not loose any progress. A pop-up window should appear and you can choose the directory in which you want to save the NM structure. We have also included an example NM structure in the example_data_simulated/ folder which has the data loaded already (called NMstruct_withData_noAnalysis).


## Parameter entry

If you have just finished the data import, you'll see that NM warns you about inclomplete parameter setup ontop of the main menu. As long as not all the necessary settings are taken care of, you will not be able to train an analysis. We see that the training parameters are not all defined, and that we did not specify a cross-validation structure yet. To do so, navigate to Set up NM parameter workspace (option 2). You can read about all the different options implemented in detail [here](define_parameter_template). For now, we will only focus on cross-validation settings, preprocessing pipeline, classification algorithm, and model saving options. 

When you see [ … ], this means that default settings will be used. The symbol [ ??? ] in front of cross-validation settings (1) and model saving options (8), means they still require user input. 

### 1. Cross-validation setup
Let’s now [define the cross-validation (CV) settings](paramtemp-cv-settings) (option 1). 

```
>> 1 (Cross-validation settings) 
```

As you may know, CV is implemented to assess generalizability and optimize parameters. Neurominer uses repeated, nested-cross validation as a default (pooled cross-validation, i.e. randomly creating the CV folds) but other frameworks are implemented as well. For now, we will just accept that as the default, alongside the default number of inner and outer permutations (1) and folds (10), so choose: 

```
>> 7 (Build Cross-Validation structure). 

>> Q or 9 (to go back to the previous menu)
```
Now you are taken back to the Define parameter template menu. You can see that the ??? behind the cv settings have disappeared. 

### 2. Preprocessing piüeline setup
Preprocessing is essential in machine learning, and within NeuroMiner it describes any steps that need to be applied to the data before training can be run. These steps comprise scaling  the data, dimensionality reduction, filtering, etc (see the [preprocessing section in the manual](preprocessing_pipeline)).
To move to the preprocessing menu, type: 

```
>> 2 (Preprocessing pipeline)
```

The pipeline that is saved in the Parameter Template is outlined at the top of the screen under “CV-PREPROCESSING PIPELINE”. Step 1 and step 2 outline the default preprocessing settings. 
If you want to add a preprocessing step, go to 

```
>> 1 (Add preprocessing step)
```

As you can see, there are many options. In your own time, you can play with these preprocessing options and see how they influence the accuracy of your predictions. 
But in this example, we just want to use the two default options, so navigate back to the _Define parameter template_ menu.


### 3. Learning algorithm setup
You will subsequently see  [various options](paramtemp_classification_algorithm) pertaining to choosing the learning algorithm for training, its parameters as well as the performance criterions for the models to be generated.

```
>> 3 (Classification algorithm)
```

If you wanted to select another learning algorithm except the default Support Vector Machine (SVM), you would choose:

```
>> 2 (Select learning algorithm)
```

For now, we will leave these options as default as well. Navigate back to the _Define parameter template_ menu.

As you can see, the model saving options are still undefined. Go to: 

```
>> 10 (Model saving options)
```

Then, press Enter to accept default suggestions and to return to the menu. 

To save the parameter template settings into an analysis which we can then train, we need to [intialize](initialize_delete_analyses) it first, i.e., tell NM that we are happy with the settings defined in the parameter template section. To do so, exit the parameter template menu and select the following steps:

```
>> 3 (Initialize analysis)

>> 1 (Define analysis identifier) 

>> CV10x10_defaults

>> 2 (Provide analysis description)

>> My first NeuroMiner analysis!

[Press Enter key to go to a new line]

>> . [The dot symbol tells NeuroMiner that you have finished]

>> 3 (Specify parent directory of the analysis) [Specify the directory using the pop-up window.]
```

If you have filled all the required information, you will now see option 4 PROCEED. Choose it. 

```
>> 4 (PROCEED)
```

By doing so NM initializes the analysis and saves all the settings that we have joust defined, including the specific cv structure, the preprocessing steps, and learning algorithm. If you would now go back to the parameter template menu and change any of these, this would not affect the already initialized analysis. Additionally, NM has created a directory on your disk which will later be filled with the result files. You can verify that your analysis folder was created in the directory that you just specified. The folder name contains an ID number and the analysis identifier in its name. 

For now, save your NM structure again, just as you did after data entry. 

## Training 

Now that your settings are initialized, you can preprocess and train your data and model. We will trail the model directly without [running only the preprocessing first] (this can be useful, though, to reduce computational costs, e.g., if you are working with very high dimensional data, such as neuroimaging, or you just want to compare the performance of different learning algorithms but using the exact same preprocessing pipeline).

In the “MAIN INTERFACE” menu, opt for the following: 

```
>> 5 (Train supervised classifiers)

>> 3 (Select CV2 partitions to operate on)

>> 1 (Select all CV2 positions)
[Press enter key to return to the previous menu]

>> 4 (PROCEED)
```

Once you click on proceed, you will see a pop-up window, the NM Optimization viewer, which displays the performance of your model during the training process in real-time. Since we did not change the default setting of “accuracy” being the [performance metric to be optimized](paramtemp_classification_algorithm), this graph displays the main accuracy of training, CV1 and CV2 folds. 


:::{admonition} Note for macOS users.
If you are using NeuroMiner for the first time you might encounter an error here caused by additional security settings. Please see [our manual](macos_users) on how to proceed in that case.
:::

Once the training is finished, you will see the training menu in the Matlab command window again. To view your results, from the main interface, choose 

```
>> 8 (View Result Viewer)
```

The different plots are described [in the section](mainmenu_display_training_results). 


## Visualization

After training the analysis, we have the option to [visualize the model](visualize_classifiers) in order to get more insights into which of our input features (that is before preprocessing) contributed to our model's predictions. 

Go to the main interface, then: 

```
>> 6 (Visualize Classifiers)

>> 7 (PROCEED)
```

With this, the analysis is complete. To visualize the results, go back to the main interface and press:

```
>> 8 (Open NM Results Viewer (cross-validation results))
```

The different plots are explained in more detail [here](visualization_results).


At this point, save your NM structure again. 


## Interpretation 

TO DO


## External validation 
Another important concept is [external validation](OOCV_analysis), i.e. generalizability of our model to external data. 

Since the validation of a model should serve as a test of generalizability and not as a tool to optimize model performance, NM strictly divides the training and the external validation phase. Once you enter into the external validation phase, you will not be able to go back to the training phase. This measure is meant for your own protection so that our claims of generalizability are not undermined! 

To go over to the external validation, lock the NeuroMiner structure containing your trained analyses:

```
>> 9 (Lock analyses and start NM application mode)

>> y[es]
[the available options in the menu should now change]
```

At this point, quickly exit NM to prepare the external validation data in the example_simulated_data folder and load the “validation_data_covars.mat” variable into the MATLAB workspace (NM has to be exited before). Note, in this simple example analysis, we are not actually using the covariates for preprocessing, so you could omit this step, but should you later implement, e.g., a site correction method like combat in your processing pipeline, it is essential to avoid running into errors later on. Then, start NeuroMiner again. 

```
>> nm

>> 2 (Load data for model application)
```

In the newly opened pop-up window, you can create external validation data containers (by clicking on "Create New..."). You will need to specify whether, in this validation set, the labels are known or not. If you have labels, you can compute external validation performance metrics, if not, you will only get the prediction scores. For now, tick the box “Target labels known”, then click on “Create New''. This creates a field in the middle blue center box that looks like this:
[ 1 ] (0 cases); date: DATE; labels known: yes

Now that we have created an empty container for our validation data, we need to fill it. To do so, press “add/modify data in dataset” which takes you to the entry menu of NeuroMiner, which is similar to the initial data entry before training. NM gives you an overview of the modalities that you had entered for the training data on top of the menu and whether you already loaded validation data for these. In our example, it is only Modality 1. To load the data, 

```
>> 1 (Add/Modify OOCV data)

>> 1 (Define data provenance)
[choose COBRE_hammers_ROI.xlsx through the pop-up window]

>> 2 (Define name of sheet in spreadsheet file)

>> 1 [to choose the first sheet]

>> 6 (IMPORT matrix)

>> 5 (Add covariate data in OOCV data)

>> Covars
```

:::{warning}
Because the original data was entered from a textfile, NeuroMiner requires a textfile for the external validation data as well. Also, NeuroMiner will expect the same variable names for the cases, groups, and the features, otherwise it will give an error. 
:::

:::{note}
In case you have loaded several modalities during the training phase, NM does not require you to load all of these for external validation datasets. It is only essential that you make sure to load all the modalities required for the specific models you are planning on validating as it will otherwise cause an error. 

The same goes for the covariates, you don't need to load them here, but if the model you later validate on this data makes use of them during a preprocessing step, it will cause an error.  
:::


Return to the main interface and: 

```
>> 3 (Set up parameters for model application)
```


TO DO: do these options actually change anything???

If you want the application of your external model to have a similar logic to the original model training, select:

```
>> 1 (Ensemble mode)

>> 2 (Compute mean decisions of CV1 partition ensembles before aggregating). 
```
Then, to accept the default in option 2 (Model retraining mode), exit to the main interface, and:

```
>> 4 (Apply classifiers to independent data)
```

By selecting this, using the winning parameters from your discovery analyses, the models will now be retrained in the discovery data before being applied to the external validation data.

Once done, you can view the results in the NM result viewer:

```
>> 6 (Open Result Viewer (cross-validation & independent test results))
```

You will then be taken to the [Results Display](visualize_classifiers) as before. After selecting the analysis you chose for the model application, you can click on the second drop-down box which shows an option to select the external validation data that you entered, as opposed to the default “Training/CV data". 